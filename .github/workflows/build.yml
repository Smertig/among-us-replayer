name: Build On Push

on:
  push:
    branches:
      - linux-support

jobs:
  build:
    runs-on: ${{matrix.os}}
    name: Build
    strategy:
      matrix:
        include:
        - name: Windows x86
          archive_suffix: win-32
          os: windows-latest
          cmake_arch: -A Win32
          is_hq: no

        - name: Windows x86-64
          archive_suffix: win-64
          os: windows-latest
          cmake_arch: -A x64
          is_hq: yes

        - name: Linux x86
          archive_suffix: linux-32
          os: ubuntu-latest
          cmake_arch: -DCMAKE_CXX_FLAGS=-m32
          is_hq: no
          packages: |
            sudo dpkg --add-architecture i386
            sudo add-apt-repository ppa:ubuntu-toolchain-r/test
            sudo apt update
            sudo apt install g++-9 g++-multilib
            echo "CC=gcc-9" >> $GITHUB_ENV
            echo "CXX=g++-9" >> $GITHUB_ENV

        - name: Linux x86-64
          archive_suffix: linux-64
          os: ubuntu-latest
          is_hq: yes
          packages: |
            sudo add-apt-repository ppa:ubuntu-toolchain-r/test
            sudo apt update
            sudo apt install linux-libc-dev:i386 gcc-9 g++-9 gcc-9-multilib g++-9-multilib
            echo "CC=gcc-9" >> $GITHUB_ENV
            echo "CXX=g++-9" >> $GITHUB_ENV

    steps:
      - uses: actions/checkout@v2

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: '>=3.6'

      - name: Install python packages
        run: pip3 install wheel cmake conan

      - name: Install dependencies
        run: ${{matrix.packages}}
        if: ${{matrix.packages}}

      - name: Create Build Environment
        run: cmake -E make_directory ${{github.workspace}}/build

      - name: Configure CMake
        shell: bash
        working-directory: ${{github.workspace}}/build
        run: |
          CONAN_SYSREQUIRES_MODE=enabled cmake .. -DCMAKE_BUILD_TYPE=Debug ${{matrix.cmake_arch}}

      - name: Build replayer
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: cmake --build . --config Debug --target among-us-replayer

      - name: Collect resources
        working-directory: ${{github.workspace}}/build
        shell: bash
        run: |
          cmake -E make_directory _dist
          if [ "${{matrix.os}}" == "windows-latest" ]
          then
            cmake -E copy bin/among-us-replayer.exe _dist/among-us-replayer.exe
            cmake -E copy bin/among-us-replayer.pdb _dist/among-us-replayer.pdb
          else
            cmake -E copy bin/among-us-replayer _dist/among-us-replayer
          fi
          cmake -E copy_directory "${{github.workspace}}/res" _dist/res
          if [ "${{matrix.is_hq}}" == "yes" ]; then cmake -E copy_directory "${{github.workspace}}/res_hq" _dist/res; fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: Debug-${{matrix.archive_suffix}}
          path: |
            ${{github.workspace}}/build/_dist
